apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: create-otel-collector
spec:
  description: |
    Deploy a per-experiment OpenTelemetry collector that writes raw traces
    to /workspace/data-pvc/<experimentId>/traces.json

  params:
    - name: results_dir
      type: string
    - name: modelLabel
      type: string

  workspaces:
    - name: data
      description: "PVC where traces will be stored at /workspace/data/<experimentId>"

  steps:
    - name: deploy-collector
      image: alpine/kubectl:1.34.1
      script: |
        #!/bin/sh
        set -eu

        EXP="$(params.modelLabel)"
        TRACE_RESULTS="$(workspaces.data.path)/$(params.results_dir)/traces.json"

        mkdir -p "$(workspaces.data.path)/$(params.results_dir)" 
        # touch "$(workspaces.data.path)/$(params.results_dir)/traces.json"

        echo "Deploying OTEL collector for experiment traces: $TRACE_RESULTS"

        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: otel-${EXP}-config
        data:
          otel-config.yaml: |
            receivers:
              otlp:
                protocols:
                  grpc:
                    endpoint: 0.0.0.0:4317
                  http:
                    endpoint: 0.0.0.0:4318
            processors:
              batch:
            exporters:
              file:
                path: ${TRACE_RESULTS}
            service:
              pipelines:
                traces:
                  receivers: [otlp]
                  processors: [batch]
                  exporters: [file]

        ---
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: otel-${EXP}
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: otel-${EXP}
          template:
            metadata:
              labels:
                app: otel-${EXP}
            spec:
              securityContext:
                fsGroup: 1000
                fsGroupChangePolicy: "OnRootMismatch"
              initContainers:
                - name: fix-perms
                  image: registry.access.redhat.com/ubi9/ubi-minimal
                  command: ["sh", "-c", "chown -R 1000:1000 /data && chmod -R u+rwX,g+rwX /data"]
                  securityContext:
                    runAsUser: 0
                  volumeMounts:
                  - name: data-storage
                    mountPath: /data
              containers:
              - name: otel-collector
                securityContext:
                  runAsUser: 1000
                  runAsGroup: 1000
                image: otel/opentelemetry-collector:latest
                args:
                  - "--config=/etc/otel/otel-config.yaml"
                volumeMounts:
                - name: otel-config
                  mountPath: /etc/otel/
                - name: data-storage
                  mountPath: $(workspaces.data.path)
              volumes:
              - name: otel-config
                configMap:
                  name: otel-${EXP}-config
              - name: data-storage
                persistentVolumeClaim:
                  claimName: $(workspaces.data.claim)

        ---
        apiVersion: v1
        kind: Service
        metadata:
          name: otel-${EXP}
        spec:
          selector:
            app: otel-${EXP}
          ports:
          - name: grpc
            port: 4317
            targetPort: 4317
          - name: http
            port: 4318
            targetPort: 4318
        EOF

        echo "OTEL collector deployed for experiment: $EXP"
