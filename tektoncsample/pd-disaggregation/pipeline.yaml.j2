# PD disaggregation example benchmark
apiVersion: tekton.dev/v1
kind: Pipeline
metadata:
  name: {{ experiment.name | dns }}
spec:
  {% if experiment.description is defined and experiment.description %}
  description: {{ experiment.description }}
  {% endif %}

  workspaces:
    - name: model-cache
      description: Location where models are stored; shared by multiple model servers
    - name: hf-credentials
      description: Workspace containing a HuggingFace token
    - name: data
      description: Workspace to temporarily store measurement results

  tasks:
    - name: log-start
      taskRef: { name: echo }
      params:
        - name: text
          value: |-
            Starting pipeline "{{ experiment.name }}"
            Assumes that secret/hf-secret is defined with field HF_TOKEN

    - name: deploy-gateway
      taskRef: { name: deploy-gateway }
      results:
        - { name: gateway, type: string }
        - { name: serviceUrl, type: string}
      params:
        - { name: releaseName, value: "gateway" }
        - { name: namespace, value: $(params.namespace) }
        - { name: valuesObject, value: {{ stack.gateway.values }} }
        {% if stack.gateway.version is defined and stack.gateway.version %}
        - { name: version, value: "{{ stack.gateway.version }}" }
        {% endif %}
        {% if stack.gateway.repo is defined and stack.gateway.repo %}
        - { name: repo, value: "{{ stack.gateway.repo }}" }
        {% endif %}
        {% if stack.gateway.repoUrl is defined and stack.gateway.repoUrl %}
        - { name: repoUrl, value: "{{ stack.gateway.repoUrl }}" }
        {% endif %}

    # Loop: set of stacks per stack (gateway, gaie, vllm)
    - loopName: per-stack
      # maxParallelism: 2
      foreach:
        domain:
          infra_i: {{ enumerate_list(stack.treatments) }}

      vars:
        stackId: "{{ infra_i.item.decodeReplicas ~ "_" ~ infra_i.item.decodeTensorParallelism ~ "_" ~ infra_i.item.prefillReplicas ~ "_" ~ infra_i.item.prefillTensorParallelism }}"
        stackModelLabel:  "{{ modelLabelPrefix }}-{{infra_i.i}}"

      tasks:
      - name: deploy-gaie-{{ stackId }}
        taskRef: { name: deploy-gaie }
        runAfter: [ deploy-gateway ]
        results:
          - { name: inferencepool, type: string }
        params:
          - { name: releaseName, value: "gaie-{{ stackId }}" }
          - { name: namespace , value: $(params.namespace) }
          - { name: valuesObject, value: {{ stack.gaie.values }} }
          {% if stack.gaie.version is defined and stack.gaie.version %}
          - { name: version, value: "{{ stack.gaie.version }}" }
          {% endif %}
          {% if stack.gaie.repo is defined and stack.gaie.repo %}
          - { name: repo, value: "{{ stack.gaie.repo }}" }
          {% endif %}
          {% if stack.gaie.repoUrl is defined and stack.gaie.repoUrl %}
          - { name: repoUrl, value: "{{ stack.gaie.repoUrl }}" }
          {% endif %}
          - name: extraSets
            value:
              - inferencepool.matchLabels.ll-d.ai/model={{ stackModelLabel }}

      - name: download-model-{{ stackId }}
        taskRef: { name: download-model }
        workspaces:
          - name: model-cache
        params:
          - name: model
            value: {{ modelId }}
          - name: HF_TOKEN

      - name: deploy-model-{{ stackId }}
        taskRef: { name: deploy-model }
        runAfter: [ download-model ]
        results:
          - { name: serviceUrl, type: string }
        params:
          - { name: releaseName, value: "model-{{ stackId }}" }
          - { name: namespace , value: $(params.namespace) }
          - { name: valuesObject, value: {{ stack.model.values }} }
          {% if stack.model.version is defined and stack.model.version %}
          - { name: version, value: "{{ stack.model.version }}" }
          {% endif %}
          {% if stack.model.repo is defined and stack.model.repo %}
          - { name: repo, value: "{{ stack.model.repo }}" }
          {% endif %}
          {% if stack.model.repoUrl is defined and stack.model.repoUrl %}
          - { name: repoUrl, value: "{{ stack.model.repoUrl }}" }
          {% endif %}
          - name: extraSets
            value:
              - modelArtifacts.name={{ modelId }}
              - modelArtifacts.uri="pvc://model-pvc/models/{{ modelId }}"
              - fullnameOverride={{ stackModelLabel }}
              - routing.inferencePool.name="$(tasks.gaie-{{ stackId }}.results.inferencepool)"
              - routing.httpRoute.rules[0].backendRefs[0].name="$(tasks.gaie-{{ stackId }}.results.inferencepool)"
              - routing.httpRoute.rules[1].backendRefs[0].name="$(tasks.gaie-{{ stackId }}.results.inferencepool)"

      - name: deploy-httproute-{{ stackId }}
        taskRef: deploy-httproute
        runAfter: [ "deploy-gaie-{{ stackId }}", deploy-gateway ]
        params:
          - { name: gateway, value: $(tasks.deploy-gateway.results.gateway) }
          - { name: inferencepool, value: "$(tasks.deploy-gaie-{{ stackId }}.results.inferencepool)" }
          - { name: model_label, value: "{{ stackModelLabel }}" }

      # inner loop
      - loopName: per-workload
        foreach:
          domain:
            treatment_i: {{ enumerate_list(workload.treatments) }}

        vars: 
          max_concurrency: "{{ treatment_i['item']['max-concurrency'] }}"
          num_prompts: "{{ treatment_i['item']['num-prompts'] }}"
          taskPostfix: "{{ stackId }}-{{ treatment_i.i }}"
          resultPath: "{{ stackId }}-{{ treatment_i['item']['max-concurrency'] }}_{{ treatment_i['item']['num-prompts'] }}"

        tasks:
        - __jinja__: |
            - name: create-workload-profile-{{ taskPostfix }}
              taskRef: { name: create-workload-profile-{{ workload.harness }} }
              results:
                - { name: profile }
              workspaces:
                - name: results
              params:
                - { name: harness, value: "{{ workload.harness }}" }
                - { name: profileTemplate, value: "{{ workload.profile }}" }
                - { name: model, value: "{{ modelId }}" }
                - { name: url, value: url }
                - name: treatment
                  value:
                    max-concurrency: "{{ max_concurrency }}"
                    num-prompts: "{{ num_prompts }}"

            - name: run-workload-{{ taskPostfix }}
              taskRef: { name: run-workload-{{ workload.harness }} }
              runAfter:
              - create-workload-profile-{{ taskPostfix }}
              {% if not treatment_i.is_first %}
              - run-workload-profile-{{ stackId }}-{{ treatment_i.prev_i }}
              {% endif %}
              workspaces:
                - name: results
              params:
                - { name: harness, value: "{{ workload.harness }}" }
                - { name: profile, value: $(tasks.create-workload-profile-{{ taskPostfix }}.results.profile) }
                - { name: path, value: "{{ resultPath }}"}

            - name: tranform-workload-results-{{ taskPostfix }}
              taskRef: { name: transform-results-{{ workload.harness }} }
              runAfter:
              - run-workload-{{ taskPostfix }}
              workspaces:
                - name: results
              params:
                - { name: sourcePath, value: "{{ resultPath }}" }
                - { name: targetPath, value: "{{ resultPath }}/converted" }


      # after workloads completed, clean up stack
      - name: delete-model-{{ stackId }}
        taskRef: { name: delete-model }
        runAfter:
          - run-workload-inference_perf_{{ stackId }}_{{ workload.treatments[-1]['max-concurrency'] }}_{{ workload.treatments[-1]['num-prompts'] }}
        params:
          - { name: releaseName, value: "model-{{ stackId }}" }
          - { name: namespace , value: $(params.namespace) }

      - name: delete-gaie-{{ stackId }}
        taskRef: { name: delete-gaie }
        runAfter:
          - run-workload-inference_perf_{{ stackId }}_{{ workload.treatments[-1]['max-concurrency'] }}_{{ workload.treatments[-1]['num-prompts'] }}
        params:
          - { name: releaseName, value: "model-{{ stackId }}" }
          - { name: namespace , value: $(params.namespace) }

    - name: document
      taskRef: { name: document }
      runAfter:
        {% for sT in stack.treatments %}
        - delete-model-{{sT.decodeReplicas}}_{{sT.decodeTensorParallelism}}_{{sT.prefillReplicas}}_{{sT.prefillTensorParallelism}}
        - delete-gaie-{{sT.decodeReplicas}}_{{sT.decodeTensorParallelism}}_{{sT.prefillReplicas}}_{{sT.prefillTensorParallelism}}
        {% endfor %}
      workspaces:
        - name: results

    {% if upload_target is defined and upload_target %}
    - name: upload
      taskRef: { name: upload-{{ upload_target.type }} }
      runAfter: [ document ]
      params:
        - name: paths
          value:
          {% for sT in stack.treatments %}
          {% for wT in workload.treatments %}
          - "{{sT.decodeReplicas}}_{{sT.decodeTensorParallelism}}_{{sT.prefillReplicas}}_{{sT.prefillTensorParallelism}}-{{wT['max-concurrency']}}_{{wT['num-prompts']}}"
          - "{{sT.decodeReplicas}}_{{sT.decodeTensorParallelism}}_{{sT.prefillReplicas}}_{{sT.prefillTensorParallelism}}-{{wT['max-concurrency']}}_{{wT['num-prompts']}}/converted"
          {% endfor %}
          {% endfor %}
        - name: target
          value: {{ upload_target.configuration }}
      workspaces:
        - name: source
        - name: credentials
    {% endif %}

  finally:
    # Loop in 'finally': make all stacks are deleted when done
    # Should we also delete results (assuming they were uploaded)
    - loopName: cleanup
      foreach:
        domain:
          infra_i: {{ enumerate_list(stack.treatments) }}
      vars:
        decodeReplicas: "{{ infra_i.item.decodeReplicas }}"
        decodeTensorParallelism: "{{ infra_i.item.decodeTensorParallelism }}"
        prefillReplicas: "{{ infra_i.item.prefillReplicas }}"
        prefillTensorParallelism: "{{ infra_i.item.prefillTensorParallelism }}"
        stackId: "{{ infra_i.item.decodeReplicas ~ "_" ~ infra_i.item.decodeTensorParallelism ~ "_" ~ infra_i.item.prefillReplicas ~ "_" ~ infra_i.item.prefillTensorParallelism }}"
      tasks:
        - name: delete-model-{{ stackId }}
          taskRef: { name: delete-model }
          params:
            - { name: releaseName, value: "model-{{ stackId }}" }
            - { name: namespace , value: $(params.namespace) }

        - name: delete-gaie-{{ stackId }}
          taskRef: { name: delete-gaie }
          params:
            - { name: releaseName, value: "model-{{ stackId }}" }
            - { name: namespace , value: $(params.namespace) }

        - name: delete-gateway-{{ stackId }}
          taskRef: { name: delete-gateway }
          params:
            - { name: releaseName, value: "gateway" }
            - { name: namespace , value: $(params.namespace) }
